import{_ as e,r as a,a as l,h as t,c as s,o,d,w as r,f as i,E as n,k as u,b as c,j as m,p,q as g,s as f,g as w,v as h,l as b,t as v,x as _,y,z as k,A as V,B as N}from"./index-vjfECZ1V.js";const C=async(e,a={})=>{const l=localStorage.getItem("token");try{const t=await fetch(`${e}`,{method:a.method||"GET",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest",...l&&{Authorization:`Bearer ${l}`},...a.headers},credentials:"include",...a});if(!t.ok){const e=await t.json().catch(()=>({}));throw new Error(e.message||`HTTP ${t.status}: ${t.statusText}`)}const s=await t.json();if(s.code&&200!==s.code)throw new Error(s.message||"请求失败");return s}catch(t){throw t}};function x(e,a){return C(`/api/user/${e}`,{method:"PUT",body:JSON.stringify(a)})}const T={class:"users-page"},A={class:"card-header"},U={class:"search-section"},$={class:"pagination"},S={class:"dialog-footer"},z=e({__name:"Users",setup(e){const z=a(!1),j=a([]),B=a(!1),P=a("add"),O=a(!1),E=a(null),L=l({keyword:"",status:"",isAdmin:""}),q=l({page:1,limit:10,total:0}),R=l({id:null,nickName:"",phoneNumber:"",email:"",password:"",isAdmin:!1,status:"active"}),D={nickName:[{required:!0,message:"请输入用户昵称",trigger:"blur"},{min:2,max:20,message:"昵称长度应在 2-20 个字符之间",trigger:"blur"}],phoneNumber:[{pattern:/^1[3-9]\d{9}$/,message:"请输入正确的手机号码",trigger:"blur"}],email:[{type:"email",message:"请输入正确的邮箱地址",trigger:"blur"}],password:[{min:6,max:20,message:"密码长度应在 6-20 个字符之间",trigger:"blur"}]},I=async()=>{z.value=!0;try{const e={page:q.page,limit:q.limit,...L},a=await function(e){const a=new URLSearchParams(e).toString();return C(`/api/user/list?${a}`)}(e);j.value=a.data.users,q.total=a.data.pagination.total}catch(e){n.error("获取用户列表失败: "+e.message)}finally{z.value=!1}},J=()=>{q.page=1,I()},F=()=>{Object.assign(L,{keyword:"",status:"",isAdmin:""}),J()},H=e=>{q.limit=e,q.page=1,I()},X=e=>{q.page=e,I()},G=()=>{P.value="add",Y(),B.value=!0},K=async e=>{try{const{value:a}=await N.prompt("请输入新密码（留空则重置为 123456）","重置密码",{confirmButtonText:"确定",cancelButtonText:"取消",inputPattern:/.*/,inputPlaceholder:"请输入新密码"}),l=a||"123456",t=await function(e,a){return C(`/api/user/${e}/reset-password`,{method:"POST",body:JSON.stringify({password:a})})}(e.id,l);200===t.code?n.success(`密码重置成功，新密码为: ${t.data.newPassword}`):n.error(t.message||"重置密码失败")}catch(a){"cancel"!==a&&n.error(a.message||"重置密码失败")}},M=async e=>{try{await N.confirm(`确定要删除用户 "${e.nickName}" 吗？此操作不可恢复！`,"删除确认",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning",confirmButtonClass:"el-button--danger"});const l=await(a=e.id,C(`/api/user/${a}`,{method:"DELETE"}));200===l.code?(n.success("用户删除成功"),I()):n.error(l.message||"删除失败")}catch(l){"cancel"!==l&&n.error(l.message||"删除用户失败")}var a},W=(e,a)=>{switch(e){case"toggleStatus":(async e=>{const a="active"===e.status?"inactive":"active",l="active"===a?"启用":"禁用";try{await N.confirm(`确定要${l}用户 "${e.nickName}" 吗？`,"状态变更确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const t=await x(e.id,{status:a});200===t.code?(n.success(`用户已${l}`),I()):n.error(t.message||`${l}失败`)}catch(t){"cancel"!==t&&n.error(t.message||"操作失败")}})(a);break;case"delete":M(a)}},Q=()=>{B.value=!1,Y()},Y=()=>{E.value&&E.value.resetFields(),Object.assign(R,{id:null,nickName:"",phoneNumber:"",email:"",password:"",isAdmin:!1,status:"active"})},Z=async()=>{var e;if(E.value)try{if(await E.value.validate(),O.value=!0,"add"===P.value){const a=await(e=R,C("/api/user/create",{method:"POST",body:JSON.stringify(e)}));200===a.code?(n.success("用户创建成功"),B.value=!1,Y(),I()):n.error(a.message||"创建失败")}else{const{id:e,...a}=R;a.password||delete a.password;const l=await x(e,a);200===l.code?(n.success("用户更新成功"),B.value=!1,Y(),I()):n.error(l.message||"更新失败")}}catch(a){!1!==a&&n.error(a.message||"操作失败")}finally{O.value=!1}},ee=e=>e?new Date(e).toLocaleString("zh-CN"):"";return t(()=>{I()}),(e,a)=>{const l=i("el-icon"),t=i("el-button"),n=i("el-input"),N=i("el-col"),C=i("el-option"),x=i("el-select"),I=i("el-row"),M=i("el-table-column"),Y=i("el-tag"),ae=i("el-dropdown-item"),le=i("el-dropdown-menu"),te=i("el-dropdown"),se=i("el-table"),oe=i("el-pagination"),de=i("el-card"),re=i("el-form-item"),ie=i("el-radio"),ne=i("el-radio-group"),ue=i("el-form"),ce=i("el-dialog"),me=u("loading");return o(),s("div",T,[d(de,null,{header:r(()=>[c("div",A,[a[13]||(a[13]=c("span",null,"用户管理",-1)),d(t,{type:"primary",onClick:G},{default:r(()=>[d(l,null,{default:r(()=>[d(g(V))]),_:1}),a[12]||(a[12]=w(" 添加用户 ",-1))]),_:1})])]),default:r(()=>[c("div",U,[d(I,{gutter:20},{default:r(()=>[d(N,{span:6},{default:r(()=>[d(n,{modelValue:L.keyword,"onUpdate:modelValue":a[0]||(a[0]=e=>L.keyword=e),placeholder:"搜索用户名、手机号或邮箱",clearable:"",onClear:J,onKeyup:p(J,["enter"])},{prefix:r(()=>[d(l,null,{default:r(()=>[d(g(f))]),_:1})]),_:1},8,["modelValue"])]),_:1}),d(N,{span:4},{default:r(()=>[d(x,{modelValue:L.status,"onUpdate:modelValue":a[1]||(a[1]=e=>L.status=e),placeholder:"用户状态",clearable:"",onChange:J},{default:r(()=>[d(C,{label:"全部",value:""}),d(C,{label:"正常",value:"active"}),d(C,{label:"禁用",value:"inactive"})]),_:1},8,["modelValue"])]),_:1}),d(N,{span:4},{default:r(()=>[d(x,{modelValue:L.isAdmin,"onUpdate:modelValue":a[2]||(a[2]=e=>L.isAdmin=e),placeholder:"用户类型",clearable:"",onChange:J},{default:r(()=>[d(C,{label:"全部",value:""}),d(C,{label:"管理员",value:"true"}),d(C,{label:"普通用户",value:"false"})]),_:1},8,["modelValue"])]),_:1}),d(N,{span:4},{default:r(()=>[d(t,{type:"primary",onClick:J},{default:r(()=>[d(l,null,{default:r(()=>[d(g(f))]),_:1}),a[14]||(a[14]=w(" 搜索 ",-1))]),_:1}),d(t,{onClick:F},{default:r(()=>[d(l,null,{default:r(()=>[d(g(h))]),_:1}),a[15]||(a[15]=w(" 重置 ",-1))]),_:1})]),_:1})]),_:1})]),m((o(),b(se,{data:j.value,stripe:"",style:{width:"100%"}},{default:r(()=>[d(M,{prop:"id",label:"ID",width:"80"}),d(M,{prop:"nickName",label:"用户名","min-width":"120"},{default:r(({row:e})=>[w(v(e.nickName||"-"),1)]),_:1}),d(M,{label:"手机号",width:"130"},{default:r(({row:e})=>[w(v(e.phoneNumber||"-"),1)]),_:1}),d(M,{label:"邮箱","min-width":"180"},{default:r(({row:e})=>[w(v(e.email||"-"),1)]),_:1}),d(M,{label:"用户类型",width:"100"},{default:r(({row:e})=>[d(Y,{type:e.isAdmin?"danger":"success"},{default:r(()=>[w(v(e.isAdmin?"管理员":"普通用户"),1)]),_:2},1032,["type"])]),_:1}),d(M,{label:"状态",width:"100"},{default:r(({row:e})=>[d(Y,{type:"active"===e.status?"success":"danger"},{default:r(()=>[w(v("active"===e.status?"正常":"禁用"),1)]),_:2},1032,["type"])]),_:1}),d(M,{prop:"lastLoginTime",label:"最后登录",width:"160"},{default:r(({row:e})=>[w(v(e.lastLoginTime?ee(e.lastLoginTime):"从未登录"),1)]),_:1}),d(M,{prop:"createdAt",label:"创建时间",width:"160"},{default:r(({row:e})=>[w(v(ee(e.createdAt)),1)]),_:1}),d(M,{label:"操作",width:"240",fixed:"right"},{default:r(({row:e})=>[d(t,{size:"small",onClick:a=>(e=>{P.value="edit",Object.assign(R,{id:e.id,nickName:e.nickName||"",phoneNumber:e.phoneNumber||"",email:e.email||"",password:"",isAdmin:e.isAdmin||!1,status:e.status||"active"}),B.value=!0})(e)},{default:r(()=>[...a[16]||(a[16]=[w("编辑",-1)])]),_:1},8,["onClick"]),d(t,{size:"small",type:"warning",onClick:a=>K(e)},{default:r(()=>[...a[17]||(a[17]=[w("重置密码",-1)])]),_:1},8,["onClick"]),d(te,{onCommand:a=>W(a,e)},{dropdown:r(()=>[d(le,null,{default:r(()=>[d(ae,{command:"toggleStatus"},{default:r(()=>[d(l,null,{default:r(()=>[d(g(y))]),_:1}),w(" "+v("active"===e.status?"禁用用户":"启用用户"),1)]),_:2},1024),d(ae,{command:"delete",divided:""},{default:r(()=>[d(l,{style:{color:"var(--el-color-danger)"}},{default:r(()=>[d(g(k))]),_:1}),a[19]||(a[19]=c("span",{style:{color:"var(--el-color-danger)"}},"删除用户",-1))]),_:1})]),_:2},1024)]),default:r(()=>[d(t,{size:"small"},{default:r(()=>[a[18]||(a[18]=w(" 更多操作",-1)),d(l,{class:"el-icon--right"},{default:r(()=>[d(g(_))]),_:1})]),_:1})]),_:2},1032,["onCommand"])]),_:1})]),_:1},8,["data"])),[[me,z.value]]),c("div",$,[d(oe,{"current-page":q.page,"onUpdate:currentPage":a[3]||(a[3]=e=>q.page=e),"page-size":q.limit,"onUpdate:pageSize":a[4]||(a[4]=e=>q.limit=e),"page-sizes":[10,20,50,100],total:q.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:H,onCurrentChange:X},null,8,["current-page","page-size","total"])])]),_:1}),d(ce,{modelValue:B.value,"onUpdate:modelValue":a[11]||(a[11]=e=>B.value=e),title:"add"===P.value?"添加用户":"编辑用户",width:"600px","close-on-click-modal":!1},{footer:r(()=>[c("div",S,[d(t,{onClick:Q},{default:r(()=>[...a[24]||(a[24]=[w("取消",-1)])]),_:1}),d(t,{type:"primary",loading:O.value,onClick:Z},{default:r(()=>[...a[25]||(a[25]=[w(" 确定 ",-1)])]),_:1},8,["loading"])])]),default:r(()=>[d(ue,{ref_key:"userFormRef",ref:E,model:R,rules:D,"label-width":"100px"},{default:r(()=>[d(re,{label:"用户昵称",prop:"nickName"},{default:r(()=>[d(n,{modelValue:R.nickName,"onUpdate:modelValue":a[5]||(a[5]=e=>R.nickName=e),placeholder:"请输入用户昵称",clearable:""},null,8,["modelValue"])]),_:1}),d(re,{label:"手机号",prop:"phoneNumber"},{default:r(()=>[d(n,{modelValue:R.phoneNumber,"onUpdate:modelValue":a[6]||(a[6]=e=>R.phoneNumber=e),placeholder:"请输入手机号",clearable:"",maxlength:"11"},null,8,["modelValue"])]),_:1}),d(re,{label:"邮箱",prop:"email"},{default:r(()=>[d(n,{modelValue:R.email,"onUpdate:modelValue":a[7]||(a[7]=e=>R.email=e),placeholder:"请输入邮箱地址",clearable:""},null,8,["modelValue"])]),_:1}),d(re,{label:"密码",prop:"password"},{default:r(()=>[d(n,{modelValue:R.password,"onUpdate:modelValue":a[8]||(a[8]=e=>R.password=e),type:"password",placeholder:"add"===P.value?"请输入密码（可选）":"留空则不修改密码",clearable:"","show-password":""},null,8,["modelValue","placeholder"])]),_:1}),d(re,{label:"用户类型",prop:"isAdmin"},{default:r(()=>[d(ne,{modelValue:R.isAdmin,"onUpdate:modelValue":a[9]||(a[9]=e=>R.isAdmin=e)},{default:r(()=>[d(ie,{label:!1},{default:r(()=>[...a[20]||(a[20]=[w("普通用户",-1)])]),_:1}),d(ie,{label:!0},{default:r(()=>[...a[21]||(a[21]=[w("管理员",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),d(re,{label:"用户状态",prop:"status"},{default:r(()=>[d(ne,{modelValue:R.status,"onUpdate:modelValue":a[10]||(a[10]=e=>R.status=e)},{default:r(()=>[d(ie,{label:"active"},{default:r(()=>[...a[22]||(a[22]=[w("正常",-1)])]),_:1}),d(ie,{label:"inactive"},{default:r(()=>[...a[23]||(a[23]=[w("禁用",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},[["__scopeId","data-v-cd2be4b8"]]);export{z as default};
