import{_ as e,r as l,a,L as t,h as n,N as s,E as o,c as i,o as d,d as u,l as r,n as p,w as c,f as m,u as f,F as v,m as h,g,b as w,q as y,C as b,O as x,A as _,t as k,P as I,D as V}from"./index-BGcfmTHn.js";import{q as B}from"./questionBank-CSjScX2A.js";import{s as j}from"./subject-0VsH4dJ8.js";import{q}from"./question-B4jbFJBZ.js";const A={class:"smart-question-import"},C={class:"card-header"},$={class:"el-upload__tip"},D={key:0},R={key:1},z={class:"button-group"},F={class:"primary-actions"},S={class:"secondary-actions"},T={class:"card-header"},P={key:0,style:{"margin-top":"8px"}},E={key:1},O={key:0,style:{"margin-top":"4px","font-size":"12px",color:"#f56c6c"}},U={style:{cursor:"help","text-decoration":"underline"}},H={class:"card-header"},Q={key:0,style:{"margin-top":"4px","font-size":"12px",color:"#f56c6c"}},W={style:{cursor:"help","text-decoration":"underline"}},L=e({__name:"SmartQuestionImport",setup(e){const L=f(),M=l("smart"),N=l(!1),X=l(!1),G=l(!1),J=l([]),K=l([]),Y=l([]),Z=l(null),ee=a({questionBankId:"",subjectId:"",duplicateHandling:"skip"}),le=l([]),ae=l([]),te=t(()=>ee.questionBankId&&ee.subjectId&&J.value.length>0);n(()=>{ne(),s(J,(e,l)=>{},{deep:!0})});const ne=async()=>{try{const e=await B.getQuestionBanks();200===e.code?le.value=e.data.list||e.data.rows||e.data||[]:o.error(e.message||"加载题库列表失败")}catch(e){o.error("加载题库列表失败: "+e.message)}},se=e=>{ee.subjectId="",ae.value=[],e&&(async e=>{try{const l=await j.getSubjects({questionBankId:e});200===l.code?ae.value=l.data.list||l.data.rows||l.data||[]:o.error(l.message||"加载科目列表失败")}catch(l){o.error("加载科目列表失败: "+l.message)}})(e)},oe=e=>{J.value=[e]},ie=(e,l)=>{o.warning("只能上传一个文件，请先删除当前文件再上传新文件")},de=e=>{J.value=[]},ue=e=>{if(!("smart"===M.value?/\.(docx|doc|xlsx|xls|pdf|txt)$/i.test(e.name):/\.(xlsx|xls|csv)$/i.test(e.name)))return o.error("文件格式不正确"),!1;return!!(e.size/1024/1024<50)||(o.error("文件大小不能超过 50MB"),!1)},re=async()=>{if(!J.value.length)return void o.warning("请先选择文件");const e=J.value[0];let l=e.raw;if(l||(l=e.originFileObj||e.file||e),l){X.value=!0;try{const e=new FormData;e.append("file",l);const a=await fetch("https://practice.insightdata.top/api/enhanced-question/preview-parse",{method:"POST",headers:{Authorization:`Bearer ${localStorage.getItem("token")}`},body:e}),t=await a.json();200===t.code?(Y.value=t.data.questions||[],o.success(`解析完成，共识别 ${t.data.total} 道题目`)):o.error(t.message||"解析失败")}catch(a){o.error("预览解析失败")}finally{X.value=!1}}else o.warning("文件数据无效，请重新选择文件")},pe=async()=>{if(te.value)try{await V.confirm(`确定要导入题目到题库"${ve()}"的科目"${he()}"吗？`,"确认导入",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),G.value=!0,"smart"===M.value?await ce():await me()}catch(e){"cancel"!==e&&o.error("导入失败: "+e.message)}finally{G.value=!1}else o.warning("请完善必填信息")},ce=async()=>{try{if(!J.value.length)return void o.error("请先选择文件");const e=J.value[0];let l=e.raw||e.originFileObj||e.file||e;if(!e||!l)return void o.error("文件数据无效，请重新选择文件");const a=new FormData;a.append("file",l),a.append("questionBankId",ee.questionBankId),a.append("subjectId",ee.subjectId),a.append("fileType",ge(e.name));const t=await fetch("https://practice.insightdata.top/api/enhanced-question/smart-upload",{method:"POST",headers:{Authorization:`Bearer ${localStorage.getItem("token")}`},body:a}),n=await t.json();200===n.code?(o.success(`成功导入 ${n.data.saved} 道题目`),L.push("/question-bank-management")):o.error(n.message||"导入失败")}catch(e){o.error("智能导入失败")}},me=async()=>{try{const e=K.value.filter(e=>e.isValid).map(e=>({questionBankId:ee.questionBankId,subjectId:ee.subjectId,chapter:e.chapter||"",content:e.content,type:e.type,options:e.options,answer:e.answer,explanation:e.explanation,images:e.images||[]})),l=await q.importQuestions(e);if(200===l.code){const l=le.value.find(e=>e.id===ee.questionBankId),a=ae.value.find(e=>e.id===ee.subjectId);o.success(`成功导入 ${e.length} 道题目到题库"${l?.name}"的科目"${a?.name}"`),L.push("/question-bank-management")}else o.error(l.message||"导入失败")}catch(e){o.error("手动导入失败")}},fe=()=>{ee.questionBankId="",ee.subjectId="",ee.duplicateHandling="skip",J.value=[],K.value=[],Y.value=[],ae.value=[]},ve=()=>{const e=le.value.find(e=>e.id===ee.questionBankId);return e?.name||""},he=()=>{const e=ae.value.find(e=>e.id===ee.subjectId);return e?.name||""},ge=e=>e.split(".").pop().toLowerCase(),we=e=>({single:"单选题",multiple:"多选题",judge:"判断题"}[e]||"未知"),ye=e=>e?e.startsWith("/images/")?`https://practice.insightdata.top${e}`:e:"";return(e,l)=>{const a=m("el-button"),t=m("el-option"),n=m("el-select"),s=m("el-form-item"),o=m("el-radio"),f=m("el-radio-group"),V=m("el-icon"),B=m("el-upload"),j=m("el-form"),q=m("el-card"),L=m("el-tag"),ne=m("el-table-column"),ce=m("el-image"),me=m("el-tooltip"),ve=m("el-table"),he=m("el-tab-pane"),ge=m("el-tabs"),be=m("el-dialog");return d(),i("div",A,[u(q,null,{header:c(()=>[w("div",C,[l[7]||(l[7]=w("span",null,"智能题目上传",-1)),u(a,{type:"text",onClick:l[0]||(l[0]=e=>N.value=!0)},{default:c(()=>[...l[6]||(l[6]=[g("使用帮助",-1)])]),_:1})])]),default:c(()=>[u(j,{model:ee,"label-width":"120px"},{default:c(()=>[u(s,{label:"选择题库：",required:""},{default:c(()=>[u(n,{modelValue:ee.questionBankId,"onUpdate:modelValue":l[1]||(l[1]=e=>ee.questionBankId=e),placeholder:"请选择题库",onChange:se,style:{width:"100%"}},{default:c(()=>[(d(!0),i(v,null,h(le.value,e=>(d(),r(t,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),u(s,{label:"选择科目：",required:""},{default:c(()=>[u(n,{modelValue:ee.subjectId,"onUpdate:modelValue":l[2]||(l[2]=e=>ee.subjectId=e),placeholder:"请选择科目",style:{width:"100%"},disabled:!ee.questionBankId},{default:c(()=>[(d(!0),i(v,null,h(ae.value,e=>(d(),r(t,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),u(s,{label:"上传模式："},{default:c(()=>[u(f,{modelValue:M.value,"onUpdate:modelValue":l[3]||(l[3]=e=>M.value=e)},{default:c(()=>[u(o,{label:"smart"},{default:c(()=>[...l[8]||(l[8]=[g("智能解析",-1)])]),_:1}),u(o,{label:"manual"},{default:c(()=>[...l[9]||(l[9]=[g("手动导入",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),u(s,{label:"上传文件："},{default:c(()=>[u(B,{ref_key:"uploadRef",ref:Z,"auto-upload":!1,"on-change":oe,"before-upload":ue,"file-list":J.value,limit:1,"on-exceed":ie,"on-remove":de,accept:"smart"===M.value?".docx,.doc,.xlsx,.xls,.pdf,.txt":".xlsx,.xls,.csv",drag:""},{tip:c(()=>[w("div",$,["smart"===M.value?(d(),i("span",D," 智能模式：支持 Word、Excel、PDF、TXT 格式，自动解析题目结构 ")):(d(),i("span",R," 手动模式：支持 Excel、CSV 格式，需要标准表格结构 "))])]),default:c(()=>[u(V,{class:"el-icon--upload"},{default:c(()=>[u(y(b))]),_:1}),l[10]||(l[10]=w("div",{class:"el-upload__text"},[g(" 将文件拖到此处，或"),w("em",null,"点击上传")],-1))]),_:1},8,["file-list","accept"])]),_:1}),"manual"===M.value?(d(),r(s,{key:0,label:"重复处理："},{default:c(()=>[u(f,{modelValue:ee.duplicateHandling,"onUpdate:modelValue":l[4]||(l[4]=e=>ee.duplicateHandling=e)},{default:c(()=>[u(o,{label:"skip"},{default:c(()=>[...l[11]||(l[11]=[g("跳过重复",-1)])]),_:1}),u(o,{label:"replace"},{default:c(()=>[...l[12]||(l[12]=[g("替换重复",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1})):p("",!0),u(s,null,{default:c(()=>[w("div",z,[w("div",F,["smart"===M.value?(d(),r(a,{key:0,type:"primary",onClick:re,loading:X.value,size:"large"},{default:c(()=>[u(V,null,{default:c(()=>[u(y(x))]),_:1}),l[13]||(l[13]=g(" 预览解析 ",-1))]),_:1},8,["loading"])):p("",!0),u(a,{type:"success",onClick:pe,loading:G.value,disabled:!te.value,size:"large"},{default:c(()=>[u(V,null,{default:c(()=>[u(y(_))]),_:1}),g(" "+k((M.value,"确认导入")),1)]),_:1},8,["loading","disabled"])]),w("div",S,[u(a,{onClick:fe,size:"default"},{default:c(()=>[u(V,null,{default:c(()=>[u(y(I))]),_:1}),l[14]||(l[14]=g(" 重置 ",-1))]),_:1})])])]),_:1})]),_:1},8,["model"])]),_:1}),Y.value.length>0?(d(),r(q,{key:0,style:{"margin-top":"20px"}},{header:c(()=>[w("div",T,[l[15]||(l[15]=w("span",null,"智能解析预览",-1)),w("div",null,[u(L,{type:"success"},{default:c(()=>[g("有效: "+k(Y.value.filter(e=>e.isValid).length),1)]),_:1}),u(L,{type:"danger",style:{"margin-left":"10px"}},{default:c(()=>[g("无效: "+k(Y.value.filter(e=>!e.isValid).length),1)]),_:1})])])]),default:c(()=>[u(ve,{data:Y.value,border:"",style:{width:"100%"}},{default:c(()=>[u(ne,{prop:"number",label:"题号",width:"80"}),u(ne,{prop:"content",label:"题目内容",width:"300","show-overflow-tooltip":""}),u(ne,{prop:"type",label:"类型",width:"100"},{default:c(e=>{return[u(L,{type:(l=e.row.type,{single:"primary",multiple:"success",judge:"warning"}[l]||"info")},{default:c(()=>[g(k(we(e.row.type)),1)]),_:2},1032,["type"])];var l}),_:1}),u(ne,{prop:"options",label:"选项",width:"200","show-overflow-tooltip":""},{default:c(e=>[(d(!0),i(v,null,h(e.row.options,e=>(d(),i("div",{key:e.key,style:{margin:"2px 0"}},[w("strong",null,k(e.key)+".",1),g(" "+k(e.content),1)]))),128))]),_:1}),u(ne,{prop:"answer",label:"答案",width:"80"}),u(ne,{prop:"explanation",label:"解析",width:"200","show-overflow-tooltip":""},{default:c(e=>[w("div",null,[w("div",null,k(e.row.explanation),1),e.row.images&&e.row.images.length>0?(d(),i("div",P,[(d(!0),i(v,null,h(e.row.images,(l,a)=>{return d(),i("div",{key:a,style:{margin:"4px 0"}},[u(ce,{src:ye(l.path),"preview-src-list":(t=e.row.images,t&&Array.isArray(t)?t.map(e=>ye(e.path)):[]),style:{width:"60px",height:"40px","border-radius":"4px"},fit:"cover","initial-index":a},null,8,["src","preview-src-list","initial-index"])]);var t}),128))])):p("",!0)])]),_:1}),u(ne,{prop:"images",label:"图片数量",width:"100"},{default:c(e=>[e.row.images&&e.row.images.length>0?(d(),r(L,{key:0,type:"info"},{default:c(()=>[g(k(e.row.images.length)+"张 ",1)]),_:2},1024)):(d(),i("span",E,"-"))]),_:1}),u(ne,{prop:"isValid",label:"状态",width:"120"},{default:c(e=>[w("div",null,[u(L,{type:e.row.isValid?"success":"danger"},{default:c(()=>[g(k(e.row.isValid?"有效":"无效"),1)]),_:2},1032,["type"]),!e.row.isValid&&e.row.invalidReasons&&e.row.invalidReasons.length>0?(d(),i("div",O,[u(me,{content:e.row.invalidReasons.join("；"),placement:"top"},{default:c(()=>[w("span",U,k(e.row.invalidReasons.length)+"个问题 ",1)]),_:2},1032,["content"])])):p("",!0)])]),_:1})]),_:1},8,["data"])]),_:1})):p("",!0),K.value.length>0?(d(),r(q,{key:1,style:{"margin-top":"20px"}},{header:c(()=>[w("div",H,[w("span",null,"预览数据 ("+k(K.value.length)+" 条)",1)])]),default:c(()=>[u(ve,{data:K.value,border:"",style:{width:"100%"}},{default:c(()=>[u(ne,{prop:"content",label:"题目内容",width:"300","show-overflow-tooltip":""}),u(ne,{prop:"type",label:"题目类型",width:"100"}),u(ne,{prop:"options",label:"选项",width:"200","show-overflow-tooltip":""}),u(ne,{prop:"answer",label:"答案",width:"80"}),u(ne,{prop:"explanation",label:"解析",width:"200","show-overflow-tooltip":""}),u(ne,{prop:"isValid",label:"状态",width:"120"},{default:c(e=>[w("div",null,[u(L,{type:e.row.isValid?"success":"danger"},{default:c(()=>[g(k(e.row.isValid?"有效":"无效"),1)]),_:2},1032,["type"]),!e.row.isValid&&e.row.invalidReasons&&e.row.invalidReasons.length>0?(d(),i("div",Q,[u(me,{content:e.row.invalidReasons.join("；"),placement:"top"},{default:c(()=>[w("span",W,k(e.row.invalidReasons.length)+"个问题 ",1)]),_:2},1032,["content"])])):p("",!0)])]),_:1})]),_:1},8,["data"])]),_:1})):p("",!0),u(be,{modelValue:N.value,"onUpdate:modelValue":l[5]||(l[5]=e=>N.value=e),title:"智能上传使用帮助",width:"800px"},{default:c(()=>[u(ge,null,{default:c(()=>[u(he,{label:"智能解析模式",name:"smart"},{default:c(()=>[...l[16]||(l[16]=[w("h4",null,"支持的文件格式：",-1),w("ul",null,[w("li",null,[w("strong",null,"Word文档 (.docx, .doc)"),g(" - 支持包含图片的文档")]),w("li",null,[w("strong",null,"Excel表格 (.xlsx, .xls)"),g(" - 支持表格格式")]),w("li",null,[w("strong",null,"PDF文档 (.pdf)"),g(" - 支持PDF格式")]),w("li",null,[w("strong",null,"文本文档 (.txt)"),g(" - 支持纯文本格式")])],-1),w("h4",null,"题目格式要求：",-1),w("pre",{style:{background:"#f5f5f5",padding:"10px","border-radius":"4px"}},"1. 以下哪个选项是正确的？\nA. 选项A的内容\nB. 选项B的内容\nC. 选项C的内容\nD. 选项D的内容\n答案：A\n解析：这是解析内容\n\n2. 第二道题目...\nA. 选项A\nB. 选项B\n答案：B\n解析：解析内容",-1),w("h4",null,"自动识别功能：",-1),w("ul",null,[w("li",null,"自动识别题目序号（1.、1、第1题等）"),w("li",null,"自动识别选项（A.、A、等）"),w("li",null,"自动识别答案（答案：A、正确答案：A等）"),w("li",null,"自动识别解析（解析：、解答：等）"),w("li",null,"自动提取图片并关联到题目"),w("li",null,"自动判断题目类型（单选、多选、判断）")],-1)])]),_:1}),u(he,{label:"手动导入模式",name:"manual"},{default:c(()=>[...l[17]||(l[17]=[w("h4",null,"支持的文件格式：",-1),w("ul",null,[w("li",null,[w("strong",null,"Excel表格 (.xlsx, .xls)")]),w("li",null,[w("strong",null,"CSV文件 (.csv)")])],-1),w("h4",null,"表格结构要求：",-1),w("table",{border:"1",style:{width:"100%","border-collapse":"collapse"}},[w("thead",null,[w("tr",null,[w("th",null,"题目内容"),w("th",null,"选项A"),w("th",null,"选项B"),w("th",null,"选项C"),w("th",null,"选项D"),w("th",null,"答案"),w("th",null,"解析")])]),w("tbody",null,[w("tr",null,[w("td",null,"以下哪个选项是正确的？"),w("td",null,"选项A的内容"),w("td",null,"选项B的内容"),w("td",null,"选项C的内容"),w("td",null,"选项D的内容"),w("td",null,"A"),w("td",null,"这是解析内容")])])],-1)])]),_:1})]),_:1})]),_:1},8,["modelValue"])])}}},[["__scopeId","data-v-a06d680d"]]);export{L as default};
