import{_ as e,r as a,a as l,h as t,E as s,c as o,o as i,d as u,w as d,f as n,k as r,p as c,g as p,q as m,x as v,j as f,l as g,t as h,F as b,m as y,b as w,D as _}from"./index-BGcfmTHn.js";import{q as x}from"./questionBank-CSjScX2A.js";import{s as k}from"./subject-0VsH4dJ8.js";const j=async(e,a={})=>{const l=localStorage.getItem("token"),t={method:a.method||"GET",headers:{"Content-Type":"application/json",...l&&{Authorization:`Bearer ${l}`}},credentials:"include",...a};try{const a=await fetch(`https://practice.insightdata.top${e}`,t),l=await a.json();if(!a.ok)throw new Error(l.message||`HTTP ${a.status}`);return l}catch(s){throw s}},V=e=>j("/api/activation-code",{method:"POST",body:JSON.stringify(e)}),C=(e={})=>{const a=new URLSearchParams(e).toString();return j(`/api/activation-code?${a}`)},A=(e,a)=>j(`/api/activation-code/${e}`,{method:"PUT",body:JSON.stringify(a)}),I=e=>j(`/api/activation-code/${e}`,{method:"DELETE"}),U={class:"activation-code-management"},z={key:0},S={key:1,class:"text-gray"},T={key:0},q={key:1,class:"text-gray"},B={key:0},E={key:1,class:"text-gray"},$={class:"subject-selection"},P={class:"selected-subjects",style:{"margin-top":"15px"}},D=e({__name:"ActivationCodeManagement",setup(e){const j=a(!1),D=a(!1),O=a(!1),L=a(null),N=l({search:"",status:""}),J=l({page:1,limit:10,total:0}),R=a([]),F=a([]),G=a([]),H=a(""),K=a(""),M=a([]),Q=a(null),W=l({name:"",description:"",subjectIds:[],expiresAt:null}),X={name:[{required:!0,message:"请输入激活码名称",trigger:"blur"}],subjectIds:[{required:!0,message:"请至少选择一个科目",trigger:"change"}]};t(()=>{Y(),Z()});const Y=async()=>{j.value=!0;try{const e={page:J.page,limit:J.limit,...N};Object.keys(e).forEach(a=>{""===e[a]&&delete e[a]});const a=await C(e);200===a.code?(R.value=a.data.list||[],J.total=a.data.total||0):s.error(a.message||"获取激活码列表失败")}catch(e){s.error("加载激活码列表失败: "+e.message)}finally{j.value=!1}},Z=async()=>{try{const e=await x.getQuestionBanks();200===e.code&&(F.value=e.data.list||[])}catch(e){}},ee=e=>{K.value="",G.value=[],e&&(async e=>{try{const a=await k.getSubjects({questionBankId:e});200===a.code&&(G.value=a.data.list||[])}catch(a){}})(e)},ae=()=>{if(!K.value)return;const e=G.value.find(e=>e.id===K.value);e&&!M.value.find(a=>a.id===e.id)&&(M.value.push(e),W.subjectIds=M.value.map(e=>e.id)),K.value=""},le=()=>{J.page=1,Y()},te=e=>{J.limit=e,J.page=1,Y()},se=e=>{J.page=e,Y()},oe=async()=>{if(Q.value)try{await Q.value.validate(),D.value=!0;const e={name:W.name,description:W.description,subjectIds:W.subjectIds,expiresAt:W.expiresAt};let a;a=L.value?await A(L.value.id,e):await V(e),200===a.code?(s.success(L.value?"更新成功":"创建成功"),O.value=!1,Y()):s.error(a.message||"操作失败")}catch(e){s.error("操作失败: "+e.message)}finally{D.value=!1}},ie=()=>{L.value=null,W.name="",W.description="",W.subjectIds=[],W.expiresAt=null,H.value="",K.value="",M.value=[],G.value=[]},ue=e=>({active:"有效",inactive:"无效",used:"已使用"}[e]||"未知"),de=e=>e?new Date(e).toLocaleString("zh-CN"):"";return(e,a)=>{const l=n("el-button"),t=n("el-input"),x=n("el-col"),k=n("el-option"),V=n("el-select"),C=n("el-icon"),A=n("el-row"),Z=n("el-card"),ne=n("el-table-column"),re=n("el-tag"),ce=n("el-table"),pe=n("el-pagination"),me=n("el-form-item"),ve=n("el-date-picker"),fe=n("el-form"),ge=n("el-dialog"),he=r("loading");return i(),o("div",U,[u(Z,{class:"search-card"},{default:d(()=>[u(A,{gutter:20},{default:d(()=>[u(x,{span:6},{default:d(()=>[u(t,{modelValue:N.search,"onUpdate:modelValue":a[0]||(a[0]=e=>N.search=e),placeholder:"搜索激活码名称或代码",clearable:"",onClear:le,onKeyup:c(le,["enter"])},{append:d(()=>[u(l,{onClick:le},{default:d(()=>[...a[12]||(a[12]=[p("搜索",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),u(x,{span:4},{default:d(()=>[u(V,{modelValue:N.status,"onUpdate:modelValue":a[1]||(a[1]=e=>N.status=e),placeholder:"状态筛选",clearable:"",onChange:le},{default:d(()=>[u(k,{label:"全部",value:""}),u(k,{label:"有效",value:"active"}),u(k,{label:"无效",value:"inactive"}),u(k,{label:"已使用",value:"used"})]),_:1},8,["modelValue"])]),_:1}),u(x,{span:4},{default:d(()=>[u(l,{type:"primary",onClick:a[2]||(a[2]=e=>O.value=!0)},{default:d(()=>[u(C,null,{default:d(()=>[u(m(v))]),_:1}),a[13]||(a[13]=p(" 创建激活码 ",-1))]),_:1})]),_:1})]),_:1})]),_:1}),u(Z,{class:"table-card"},{default:d(()=>[f((i(),g(ce,{data:R.value,border:"",style:{width:"100%"}},{default:d(()=>[u(ne,{prop:"code",label:"激活码",width:"120"}),u(ne,{prop:"name",label:"名称",width:"150","show-overflow-tooltip":""}),u(ne,{prop:"description",label:"描述",width:"200","show-overflow-tooltip":""}),u(ne,{prop:"status",label:"状态",width:"100"},{default:d(e=>{return[u(re,{type:(a=e.row.status,{active:"success",inactive:"info",used:"warning"}[a]||"info")},{default:d(()=>[p(h(ue(e.row.status)),1)]),_:2},1032,["type"])];var a}),_:1}),u(ne,{prop:"user",label:"绑定用户",width:"120"},{default:d(e=>[e.row.user?(i(),o("span",z,h(e.row.user.phone_number||e.row.user.email),1)):(i(),o("span",S,"未绑定"))]),_:1}),u(ne,{prop:"subjects",label:"包含科目",width:"200"},{default:d(e=>[(i(!0),o(b,null,y(e.row.subjects,e=>(i(),g(re,{key:e.id,size:"small",style:{"margin-right":"5px","margin-bottom":"5px"}},{default:d(()=>[p(h(e.questionBank.name)+" - "+h(e.name),1)]),_:2},1024))),128))]),_:1}),u(ne,{prop:"expiresAt",label:"过期时间",width:"150"},{default:d(e=>[e.row.expiresAt?(i(),o("span",T,h(de(e.row.expiresAt)),1)):(i(),o("span",q,"永不过期"))]),_:1}),u(ne,{prop:"usedAt",label:"使用时间",width:"150"},{default:d(e=>[e.row.usedAt?(i(),o("span",B,h(de(e.row.usedAt)),1)):(i(),o("span",E,"未使用"))]),_:1}),u(ne,{prop:"createdAt",label:"创建时间",width:"150"},{default:d(e=>[p(h(de(e.row.createdAt)),1)]),_:1}),u(ne,{label:"操作",width:"200",fixed:"right"},{default:d(e=>[u(l,{type:"primary",size:"small",onClick:a=>{return l=e.row,L.value=l,W.name=l.name,W.description=l.description,W.expiresAt=l.expiresAt?new Date(l.expiresAt):null,W.subjectIds=l.subjects.map(e=>e.id),M.value=l.subjects,void(O.value=!0);var l}},{default:d(()=>[...a[14]||(a[14]=[p(" 编辑 ",-1)])]),_:1},8,["onClick"]),u(l,{type:"danger",size:"small",onClick:a=>(async e=>{try{await _.confirm(`确定要删除激活码"${e.name}"吗？`,"确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const a=await I(e.id);200===a.code?(s.success("删除成功"),Y()):s.error(a.message||"删除失败")}catch(a){"cancel"!==a&&s.error("删除失败: "+a.message)}})(e.row)},{default:d(()=>[...a[15]||(a[15]=[p(" 删除 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[he,j.value]]),u(pe,{"current-page":J.page,"onUpdate:currentPage":a[3]||(a[3]=e=>J.page=e),"page-size":J.limit,"onUpdate:pageSize":a[4]||(a[4]=e=>J.limit=e),"page-sizes":[10,20,50,100],total:J.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:te,onCurrentChange:se,style:{"margin-top":"20px","text-align":"right"}},null,8,["current-page","page-size","total"])]),_:1}),u(ge,{modelValue:O.value,"onUpdate:modelValue":a[11]||(a[11]=e=>O.value=e),title:L.value?"编辑激活码":"创建激活码",width:"800px",onClose:ie},{footer:d(()=>[u(l,{onClick:a[10]||(a[10]=e=>O.value=!1)},{default:d(()=>[...a[18]||(a[18]=[p("取消",-1)])]),_:1}),u(l,{type:"primary",onClick:oe,loading:D.value},{default:d(()=>[p(h(L.value?"更新":"创建"),1)]),_:1},8,["loading"])]),default:d(()=>[u(fe,{model:W,rules:X,ref_key:"formRef",ref:Q,"label-width":"120px"},{default:d(()=>[u(me,{label:"激活码名称",prop:"name"},{default:d(()=>[u(t,{modelValue:W.name,"onUpdate:modelValue":a[5]||(a[5]=e=>W.name=e),placeholder:"请输入激活码名称"},null,8,["modelValue"])]),_:1}),u(me,{label:"描述",prop:"description"},{default:d(()=>[u(t,{modelValue:W.description,"onUpdate:modelValue":a[6]||(a[6]=e=>W.description=e),type:"textarea",rows:3,placeholder:"请输入激活码描述"},null,8,["modelValue"])]),_:1}),u(me,{label:"包含科目",prop:"subjectIds"},{default:d(()=>[w("div",$,[u(A,{gutter:20},{default:d(()=>[u(x,{span:8},{default:d(()=>[u(V,{modelValue:H.value,"onUpdate:modelValue":a[7]||(a[7]=e=>H.value=e),placeholder:"选择题库",onChange:ee,style:{width:"100%"}},{default:d(()=>[(i(!0),o(b,null,y(F.value,e=>(i(),g(k,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),u(x,{span:8},{default:d(()=>[u(V,{modelValue:K.value,"onUpdate:modelValue":a[8]||(a[8]=e=>K.value=e),placeholder:"选择科目",onChange:ae,style:{width:"100%"},disabled:!H.value},{default:d(()=>[(i(!0),o(b,null,y(G.value,e=>(i(),g(k,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),u(x,{span:8},{default:d(()=>[u(l,{type:"primary",onClick:ae,disabled:!K.value},{default:d(()=>[...a[16]||(a[16]=[p(" 添加科目 ",-1)])]),_:1},8,["disabled"])]),_:1})]),_:1}),w("div",P,[a[17]||(a[17]=w("h4",null,"已选择的科目：",-1)),(i(!0),o(b,null,y(M.value,e=>(i(),g(re,{key:e.id,closable:"",onClose:a=>{return l=e.id,M.value=M.value.filter(e=>e.id!==l),void(W.subjectIds=M.value.map(e=>e.id));var l},style:{"margin-right":"10px","margin-bottom":"10px"}},{default:d(()=>[p(h(e.questionBank.name)+" - "+h(e.name),1)]),_:2},1032,["onClose"]))),128))])])]),_:1}),u(me,{label:"过期时间"},{default:d(()=>[u(ve,{modelValue:W.expiresAt,"onUpdate:modelValue":a[9]||(a[9]=e=>W.expiresAt=e),type:"datetime",placeholder:"选择过期时间（可选）",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},[["__scopeId","data-v-5cf5f88e"]]);export{D as default};
