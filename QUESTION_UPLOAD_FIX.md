# é¢˜ç›®ä¸Šä¼ å¤–é”®çº¦æŸé”™è¯¯ä¿®å¤æŒ‡å—

## ğŸš¨ é—®é¢˜æè¿°

é¢˜ç›®ä¸Šä¼ æ—¶å‡ºç°å¤–é”®çº¦æŸé”™è¯¯ï¼š
```
Error: Cannot add or update a child row: a foreign key constraint fails (`practice`.`questions`, CONSTRAINT `questions_ibfk_90` FOREIGN KEY (`subject_id`) REFERENCES `subjects` (`id`) ON DELETE CASCADE ON UPDATE CASCADE)
```

## ğŸ” é—®é¢˜åˆ†æ

### é”™è¯¯åŸå› 
**å¤–é”®çº¦æŸå¤±è´¥**: `subject_id` å­—æ®µçš„å€¼ä¸ºç©ºå­—ç¬¦ä¸² `''`ï¼Œä½†æ•°æ®åº“ä¸­çš„å¤–é”®çº¦æŸè¦æ±‚è¿™ä¸ªå€¼å¿…é¡»å­˜åœ¨äº `subjects` è¡¨ä¸­ã€‚

### æ ¹æœ¬åŸå› 
1. **å‰ç«¯ä¼ é€’ç§‘ç›®åç§°**: å‰ç«¯ä¼ é€’çš„æ˜¯ç§‘ç›®åç§°ï¼ˆ`subject`ï¼‰ï¼Œè€Œä¸æ˜¯ç§‘ç›®IDï¼ˆ`subjectId`ï¼‰
2. **åç«¯ç¼ºå°‘è½¬æ¢é€»è¾‘**: åç«¯ç›´æ¥ä½¿ç”¨ç©ºçš„ `subjectId` å­—æ®µ
3. **éªŒè¯ä¸å……åˆ†**: æ²¡æœ‰éªŒè¯ `subjectId` æ˜¯å¦ä¸ºç©ºå­—ç¬¦ä¸²

### é”™è¯¯æ•°æ®ç¤ºä¾‹
```javascript
{
  subjectId: '',  // ç©ºå­—ç¬¦ä¸²ï¼Œå¯¼è‡´å¤–é”®çº¦æŸå¤±è´¥
  questionBankId: '3',
  content: 'é¢˜ç›®å†…å®¹...',
  // ... å…¶ä»–å­—æ®µ
}
```

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### ä¿®å¤å†…å®¹

#### 1. æ™ºèƒ½ä¸Šä¼ æ§åˆ¶å™¨ä¿®å¤
**æ–‡ä»¶**: `server/controllers/enhancedQuestionController.js`

**æ·»åŠ å‚æ•°éªŒè¯**:
```javascript
if (!questionBankId || !subjectId || subjectId === '') {
  ctx.body = { code: 400, message: 'è¯·é€‰æ‹©é¢˜åº“å’Œç§‘ç›®' };
  return;
}
```

**æ·»åŠ æ•°å­—è½¬æ¢éªŒè¯**:
```javascript
const subjectIdNum = parseInt(subjectId);
if (isNaN(subjectIdNum) || subjectIdNum <= 0) {
  ctx.body = { code: 400, message: 'ç§‘ç›®IDæ— æ•ˆ' };
  return;
}
```

**æ·»åŠ è°ƒè¯•æ—¥å¿—**:
```javascript
console.log('=== æ™ºèƒ½ä¸Šä¼ å‚æ•° ===');
console.log('questionBankId:', questionBankId);
console.log('subjectId:', subjectId);
console.log('subjectIdç±»å‹:', typeof subjectId);
console.log('subjectIdæ˜¯å¦ä¸ºç©ºå­—ç¬¦ä¸²:', subjectId === '');
```

#### 2. é¢˜ç›®å¯¼å…¥æ§åˆ¶å™¨ä¿®å¤
**æ–‡ä»¶**: `server/controllers/questionController.js`

**æ·»åŠ ç§‘ç›®IDå¤„ç†é€»è¾‘**:
```javascript
// å¤„ç†ç§‘ç›®ID
let subjectId = question.subjectId;

// å¦‚æœæ²¡æœ‰subjectIdä½†æœ‰subjectåç§°ï¼Œéœ€è¦æŸ¥æ‰¾å¯¹åº”çš„ç§‘ç›®ID
if (!subjectId && question.subject) {
  try {
    const subject = await Subject.findOne({
      where: { name: question.subject }
    });
    if (subject) {
      subjectId = subject.id;
    } else {
      // åˆ›å»ºä¸€ä¸ªæ–°çš„ç§‘ç›®
      const newSubject = await Subject.create({
        name: question.subject,
        description: question.subject,
        questionBankId: question.questionBankId || 1
      });
      subjectId = newSubject.id;
    }
  } catch (error) {
    console.error('å¤„ç†ç§‘ç›®å¤±è´¥:', error);
    subjectId = 1; // ä½¿ç”¨é»˜è®¤ç§‘ç›®ID
  }
}

// å¦‚æœä»ç„¶æ²¡æœ‰subjectIdï¼Œä½¿ç”¨é»˜è®¤å€¼
if (!subjectId) {
  subjectId = 1; // é»˜è®¤ç§‘ç›®ID
}
```

### ä¿®å¤åŸç†
1. **å‚æ•°éªŒè¯**: æ£€æŸ¥ `subjectId` æ˜¯å¦ä¸ºç©ºå­—ç¬¦ä¸²
2. **ç±»å‹è½¬æ¢**: å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•°å­—å¹¶éªŒè¯
3. **ç§‘ç›®æŸ¥æ‰¾**: æ ¹æ®ç§‘ç›®åç§°æŸ¥æ‰¾å¯¹åº”çš„ç§‘ç›®ID
4. **è‡ªåŠ¨åˆ›å»º**: å¦‚æœç§‘ç›®ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨åˆ›å»ºæ–°ç§‘ç›®
5. **é»˜è®¤å€¼**: å¦‚æœæ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ç§‘ç›®ID

## ğŸ“‹ ä¿®å¤éªŒè¯

### æ£€æŸ¥ç»“æœ
âœ… **æ‰€æœ‰ä¿®å¤å·²åº”ç”¨**
- æ™ºèƒ½ä¸Šä¼ æ§åˆ¶å™¨: æ·»åŠ äº†å‚æ•°éªŒè¯å’Œè°ƒè¯•æ—¥å¿—
- é¢˜ç›®å¯¼å…¥æ§åˆ¶å™¨: æ·»åŠ äº†ç§‘ç›®IDå¤„ç†é€»è¾‘
- æ•°æ®åº“æ¨¡å‹: å­—æ®µå®šä¹‰æ­£ç¡®
- å‰ç«¯ä»£ç : æ­£ç¡®è®¾ç½®ç§‘ç›®å­—æ®µ

### éªŒè¯å‘½ä»¤
```bash
# è¿è¡Œä¿®å¤æ£€æŸ¥è„šæœ¬
node test-question-upload-fix.js
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### ä¿®å¤åçš„æµç¨‹
1. **å‰ç«¯ä¸Šä¼ **: ç”¨æˆ·é€‰æ‹©æ–‡ä»¶å¹¶è¾“å…¥ç§‘ç›®åç§°
2. **å‚æ•°éªŒè¯**: åç«¯éªŒè¯å‚æ•°å®Œæ•´æ€§
3. **ç§‘ç›®å¤„ç†**: æ ¹æ®ç§‘ç›®åç§°æŸ¥æ‰¾æˆ–åˆ›å»ºç§‘ç›®
4. **é¢˜ç›®ä¿å­˜**: ä½¿ç”¨æœ‰æ•ˆçš„ç§‘ç›®IDä¿å­˜é¢˜ç›®

### æµ‹è¯•æ­¥éª¤
1. æ‰“å¼€å°ç¨‹åºç®¡ç†åå°
2. è¿›å…¥é¢˜ç›®ä¸Šä¼ é¡µé¢
3. é€‰æ‹©TXTæ–‡æ¡£
4. è¾“å…¥ç§‘ç›®åç§°ï¼ˆå¦‚"è®¡ç®—æœºç½‘ç»œ"ï¼‰
5. ä¸Šä¼ æ–‡ä»¶
6. æ£€æŸ¥æ˜¯å¦æˆåŠŸ

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### æ•°æ®æµç¨‹
```
å‰ç«¯: subject = "è®¡ç®—æœºç½‘ç»œ"
  â†“
åç«¯: æŸ¥æ‰¾ç§‘ç›®ID
  â†“
æ•°æ®åº“: å¦‚æœå­˜åœ¨ï¼Œä½¿ç”¨ç°æœ‰IDï¼›å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°ç§‘ç›®
  â†“
ä¿å­˜: subjectId = æœ‰æ•ˆçš„æ•°å­—ID
```

### å…³é”®ä»£ç é€»è¾‘
```javascript
// 1. å‚æ•°éªŒè¯
if (!subjectId || subjectId === '') {
  throw new Error('ç§‘ç›®IDæ— æ•ˆ');
}

// 2. ç§‘ç›®æŸ¥æ‰¾
const subject = await Subject.findOne({
  where: { name: question.subject }
});

// 3. è‡ªåŠ¨åˆ›å»º
if (!subject) {
  const newSubject = await Subject.create({
    name: question.subject,
    questionBankId: question.questionBankId || 1
  });
  subjectId = newSubject.id;
}

// 4. ä¿å­˜é¢˜ç›®
await Question.create({
  subjectId: subjectId,
  // ... å…¶ä»–å­—æ®µ
});
```

### ç›¸å…³æ–‡ä»¶
- `server/controllers/enhancedQuestionController.js` - æ™ºèƒ½ä¸Šä¼ æ§åˆ¶å™¨
- `server/controllers/questionController.js` - é¢˜ç›®å¯¼å…¥æ§åˆ¶å™¨
- `server/models/Question.js` - é¢˜ç›®æ¨¡å‹
- `server/models/Subject.js` - ç§‘ç›®æ¨¡å‹
- `miniprogram/pages/question-upload/index.js` - å‰ç«¯ä¸Šä¼ é¡µé¢

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. æ•°æ®éªŒè¯
- å§‹ç»ˆéªŒè¯å¿…å¡«å­—æ®µ
- æ£€æŸ¥å­—æ®µç±»å‹å’Œæ ¼å¼
- æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯

### 2. å¤–é”®å¤„ç†
- ç¡®ä¿å¤–é”®å­—æ®µä¸ä¸ºç©º
- éªŒè¯å¤–é”®å¼•ç”¨çš„è®°å½•å­˜åœ¨
- æä¾›åˆç†çš„é»˜è®¤å€¼

### 3. é”™è¯¯å¤„ç†
- æ•è·å¹¶è®°å½•é”™è¯¯
- æä¾›ç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
- å®ç°é™çº§å¤„ç†æœºåˆ¶

## ğŸ”„ ç»´æŠ¤å»ºè®®

### å®šæœŸæ£€æŸ¥
1. ç›‘æ§å¤–é”®çº¦æŸé”™è¯¯
2. æ£€æŸ¥ç§‘ç›®æ•°æ®å®Œæ•´æ€§
3. éªŒè¯é¢˜ç›®ä¸Šä¼ æˆåŠŸç‡
4. æ”¶é›†ç”¨æˆ·åé¦ˆ

### ç›‘æ§æŒ‡æ ‡
- é¢˜ç›®ä¸Šä¼ æˆåŠŸç‡
- å¤–é”®çº¦æŸé”™è¯¯ç‡
- ç§‘ç›®åˆ›å»ºæ•°é‡
- ç”¨æˆ·æ“ä½œæ»¡æ„åº¦

## ğŸ“ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **ä»ç„¶å‡ºç°å¤–é”®çº¦æŸé”™è¯¯**
   - æ£€æŸ¥ç§‘ç›®è¡¨ä¸­æ˜¯å¦æœ‰IDä¸º1çš„è®°å½•
   - éªŒè¯ç§‘ç›®åç§°æ˜¯å¦æ­£ç¡®
   - ç¡®è®¤æ•°æ®åº“è¿æ¥æ­£å¸¸

2. **ç§‘ç›®åˆ›å»ºå¤±è´¥**
   - æ£€æŸ¥Subjectæ¨¡å‹å®šä¹‰
   - éªŒè¯questionBankIdæ˜¯å¦å­˜åœ¨
   - ç¡®è®¤æ•°æ®åº“æƒé™

3. **é¢˜ç›®ä¿å­˜å¤±è´¥**
   - æ£€æŸ¥Questionæ¨¡å‹å®šä¹‰
   - éªŒè¯æ‰€æœ‰å¿…å¡«å­—æ®µ
   - ç¡®è®¤æ•°æ®ç±»å‹æ­£ç¡®

### è°ƒè¯•å‘½ä»¤
```bash
# æ£€æŸ¥æ•°æ®åº“ä¸­çš„ç§‘ç›®
SELECT * FROM subjects LIMIT 10;

# æ£€æŸ¥é¢˜ç›®è¡¨ç»“æ„
DESCRIBE questions;

# æ£€æŸ¥å¤–é”®çº¦æŸ
SHOW CREATE TABLE questions;
```

## âœ… ä¿®å¤ç¡®è®¤

ä¿®å¤å®Œæˆåï¼Œè¯·ç¡®è®¤ä»¥ä¸‹é¡¹ç›®ï¼š

- [x] æ™ºèƒ½ä¸Šä¼ æ§åˆ¶å™¨æ·»åŠ äº†å‚æ•°éªŒè¯
- [x] é¢˜ç›®å¯¼å…¥æ§åˆ¶å™¨æ·»åŠ äº†ç§‘ç›®IDå¤„ç†
- [x] æ·»åŠ äº†ç§‘ç›®æŸ¥æ‰¾å’Œåˆ›å»ºé€»è¾‘
- [x] æ·»åŠ äº†é»˜è®¤ç§‘ç›®IDå¤„ç†
- [x] æ·»åŠ äº†è°ƒè¯•æ—¥å¿—
- [x] æµ‹è¯•è„šæœ¬éªŒè¯é€šè¿‡
- [x] æ–‡æ¡£å·²æ›´æ–°

## ğŸ“Š é¢„æœŸæ•ˆæœ

ä¿®å¤åçš„æ•ˆæœï¼š
- âœ… ä¸å†å‡ºç°å¤–é”®çº¦æŸé”™è¯¯
- âœ… é¢˜ç›®å¯ä»¥æ­£å¸¸ä¸Šä¼ 
- âœ… ç§‘ç›®ä¿¡æ¯æ­£ç¡®å…³è”
- âœ… è‡ªåŠ¨åˆ›å»ºç¼ºå¤±çš„ç§‘ç›®
- âœ… æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
- âœ… æ”¯æŒçµæ´»çš„ç§‘ç›®ç®¡ç†

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### ä¿®å¤å‰åå¯¹æ¯”
```
ä¿®å¤å‰: subjectId: '' â†’ å¤–é”®çº¦æŸé”™è¯¯
ä¿®å¤å: subjectId: 5 â†’ æˆåŠŸä¿å­˜
```

### æµ‹è¯•ç”¨ä¾‹
```javascript
// æµ‹è¯•æ•°æ®
const questionData = {
  subject: "è®¡ç®—æœºç½‘ç»œ",  // ç§‘ç›®åç§°
  content: "é¢˜ç›®å†…å®¹",
  options: [...],
  answer: "A"
};

// ä¿®å¤åçš„å¤„ç†æµç¨‹
// 1. æŸ¥æ‰¾ç§‘ç›®"è®¡ç®—æœºç½‘ç»œ"çš„ID
// 2. å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°ç§‘ç›®
// 3. ä½¿ç”¨æœ‰æ•ˆçš„ç§‘ç›®IDä¿å­˜é¢˜ç›®
```

ç°åœ¨é¢˜ç›®ä¸Šä¼ åº”è¯¥ä¸ä¼šå†å‡ºç°å¤–é”®çº¦æŸé”™è¯¯äº†ï¼
