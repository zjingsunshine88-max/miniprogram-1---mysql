# åˆ·é¢˜å°ç¨‹åºç³»ç»Ÿ - ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²è¯´æ˜

## ğŸ“‹ ç³»ç»Ÿæ¦‚è¿°

æœ¬ç³»ç»ŸåŒ…å«ä¸‰ä¸ªä¸»è¦éƒ¨åˆ†ï¼š
- **Adminç®¡ç†åå°**ï¼šVue.js + Element Plus æ„å»ºçš„ç®¡ç†ç•Œé¢
- **Serveråç«¯æœåŠ¡**ï¼šNode.js + Koa + MySQL æ„å»ºçš„APIæœåŠ¡
- **Mini-programå°ç¨‹åº**ï¼šå¾®ä¿¡å°ç¨‹åºå‰ç«¯

## ğŸ› ï¸ ç¯å¢ƒè¦æ±‚

### æœåŠ¡å™¨ç¯å¢ƒ
- **æ“ä½œç³»ç»Ÿ**ï¼šLinux (æ¨è Ubuntu 20.04+ æˆ– CentOS 7+)
- **Node.js**ï¼šv16.0+ (æ¨è v18.x LTS)
- **MySQL**ï¼šv8.0+
- **Nginx**ï¼šv1.18+ (ç”¨äºåå‘ä»£ç†å’Œé™æ€æ–‡ä»¶æœåŠ¡)
- **PM2**ï¼šç”¨äºè¿›ç¨‹ç®¡ç†

### å¼€å‘ç¯å¢ƒ
- **å¾®ä¿¡å¼€å‘è€…å·¥å…·**ï¼šæœ€æ–°ç‰ˆæœ¬
- **Git**ï¼šç”¨äºä»£ç ç®¡ç†

## ğŸ“ é¡¹ç›®ç»“æ„

```
miniprogram-1-mysql/
â”œâ”€â”€ admin/                 # ç®¡ç†åå°
â”‚   â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ vite.config.js
â”œâ”€â”€ server/               # åç«¯æœåŠ¡
â”‚   â”œâ”€â”€ controllers/
â”‚   â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ middlewares/
â”‚   â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ app.js
â”œâ”€â”€ miniprogram/          # å¾®ä¿¡å°ç¨‹åº
â”‚   â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ app.js
â”‚   â””â”€â”€ app.json
â””â”€â”€ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²è¯´æ˜.md
```

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šæœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡

#### 1.1 å®‰è£… Node.js
```bash
# ä½¿ç”¨ NodeSource å®‰è£… Node.js 18.x
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# éªŒè¯å®‰è£…
node --version
npm --version
```

#### 1.2 å®‰è£… MySQL
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install mysql-server

# CentOS/RHEL
sudo yum install mysql-server

# å¯åŠ¨ MySQL æœåŠ¡
sudo systemctl start mysql
sudo systemctl enable mysql

# å®‰å…¨é…ç½®
sudo mysql_secure_installation
```

#### 1.3 å®‰è£… Nginx
```bash
# Ubuntu/Debian
sudo apt install nginx

# CentOS/RHEL
sudo yum install nginx

# å¯åŠ¨ Nginx
sudo systemctl start nginx
sudo systemctl enable nginx
```

#### 1.4 å®‰è£… PM2
```bash
sudo npm install -g pm2
```

### ç¬¬äºŒæ­¥ï¼šæ•°æ®åº“é…ç½®

#### 2.1 åˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·
```sql
-- ç™»å½• MySQL
mysql -u root -p

-- åˆ›å»ºæ•°æ®åº“
CREATE DATABASE question_bank_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- åˆ›å»ºç”¨æˆ·
CREATE USER 'question_user'@'localhost' IDENTIFIED BY 'your_strong_password';

-- æˆæƒ
GRANT ALL PRIVILEGES ON question_bank_db.* TO 'question_user'@'localhost';
FLUSH PRIVILEGES;

-- é€€å‡º
EXIT;
```

#### 2.2 é…ç½®æ•°æ®åº“è¿æ¥
ç¼–è¾‘ `server/config/database.js`ï¼š
```javascript
module.exports = {
  development: {
    username: 'question_user',
    password: 'your_strong_password',
    database: 'question_bank_db',
    host: 'localhost',
    dialect: 'mysql',
    timezone: '+08:00'
  },
  production: {
    username: 'question_user',
    password: 'your_strong_password',
    database: 'question_bank_db',
    host: 'localhost',
    dialect: 'mysql',
    timezone: '+08:00',
    logging: false, // ç”Ÿäº§ç¯å¢ƒå…³é—­SQLæ—¥å¿—
    pool: {
      max: 20,
      min: 0,
      acquire: 30000,
      idle: 10000
    }
  }
}
```

### ç¬¬ä¸‰æ­¥ï¼šä»£ç éƒ¨ç½²

#### 3.1 å…‹éš†ä»£ç 
```bash
# åˆ›å»ºé¡¹ç›®ç›®å½•
sudo mkdir -p /var/www/question-bank
sudo chown -R $USER:$USER /var/www/question-bank
cd /var/www/question-bank

# å…‹éš†ä»£ç ï¼ˆæ›¿æ¢ä¸ºå®é™…ä»“åº“åœ°å€ï¼‰
git clone https://github.com/your-username/miniprogram-1-mysql.git .
```

#### 3.2 å®‰è£…ä¾èµ–

**å®‰è£… Server ä¾èµ–ï¼š**
```bash
cd server
npm install --production
```

**å®‰è£… Admin ä¾èµ–ï¼š**
```bash
cd ../admin
npm install
```

#### 3.3 æ„å»º Admin å‰ç«¯
```bash
cd admin
npm run build
```

æ„å»ºå®Œæˆåï¼Œ`dist` ç›®å½•å°†åŒ…å«ç”Ÿäº§ç¯å¢ƒçš„é™æ€æ–‡ä»¶ã€‚

### ç¬¬å››æ­¥ï¼šé…ç½®æœåŠ¡

#### 4.1 é…ç½® Nginx

åˆ›å»º Nginx é…ç½®æ–‡ä»¶ `/etc/nginx/sites-available/question-bank`ï¼š

```nginx
server {
    listen 80;
    server_name your-domain.com;  # æ›¿æ¢ä¸ºå®é™…åŸŸå
    
    # ç®¡ç†åå°
    location / {
        root /var/www/question-bank/admin/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
    }
    
    # API æœåŠ¡
    location /api/ {
        proxy_pass http://localhost:3002;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
    
    # é™æ€æ–‡ä»¶æœåŠ¡
    location /uploads/ {
        alias /var/www/question-bank/server/public/uploads/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # å®‰å…¨å¤´
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
}
```

å¯ç”¨é…ç½®ï¼š
```bash
sudo ln -s /etc/nginx/sites-available/question-bank /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

#### 4.2 é…ç½® PM2

åˆ›å»º PM2 é…ç½®æ–‡ä»¶ `server/ecosystem.config.js`ï¼š

```javascript
module.exports = {
  apps: [{
    name: 'question-bank-server',
    script: 'app.js',
    cwd: '/var/www/question-bank/server',
    instances: 2, // æ ¹æ®CPUæ ¸å¿ƒæ•°è°ƒæ•´
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3002
    },
    error_file: '/var/log/pm2/question-bank-error.log',
    out_file: '/var/log/pm2/question-bank-out.log',
    log_file: '/var/log/pm2/question-bank-combined.log',
    time: true,
    max_memory_restart: '1G',
    node_args: '--max_old_space_size=1024'
  }]
}
```

### ç¬¬äº”æ­¥ï¼šå¯åŠ¨æœåŠ¡

#### 5.1 åˆå§‹åŒ–æ•°æ®åº“
```bash
cd /var/www/question-bank/server
NODE_ENV=production node -e "
const { sequelize } = require('./config/database');
sequelize.sync({ force: false }).then(() => {
  console.log('æ•°æ®åº“åŒæ­¥å®Œæˆ');
  process.exit(0);
}).catch(err => {
  console.error('æ•°æ®åº“åŒæ­¥å¤±è´¥:', err);
  process.exit(1);
});
"
```

#### 5.2 å¯åŠ¨åç«¯æœåŠ¡
```bash
cd /var/www/question-bank/server
pm2 start ecosystem.config.js
pm2 save
pm2 startup
```

#### 5.3 éªŒè¯æœåŠ¡çŠ¶æ€
```bash
# æ£€æŸ¥ PM2 è¿›ç¨‹
pm2 status

# æ£€æŸ¥æœåŠ¡æ—¥å¿—
pm2 logs question-bank-server

# æ£€æŸ¥ç«¯å£ç›‘å¬
sudo netstat -tlnp | grep :3002

# æµ‹è¯• API
curl http://localhost:3002/health
```

## ğŸ”§ å°ç¨‹åºé…ç½®

### 6.1 ä¿®æ”¹å°ç¨‹åºé…ç½®

ç¼–è¾‘ `miniprogram/utils/server-api.js`ï¼Œæ›´æ–°æœåŠ¡å™¨åœ°å€ï¼š

```javascript
// ç”Ÿäº§ç¯å¢ƒé…ç½®
const getServerUrl = () => {
  return 'https://your-domain.com'  // æ›¿æ¢ä¸ºå®é™…åŸŸå
}
```

### 6.2 å¾®ä¿¡å°ç¨‹åºé…ç½®

1. **ç™»å½•å¾®ä¿¡å…¬ä¼—å¹³å°**ï¼šhttps://mp.weixin.qq.com
2. **é…ç½®æœåŠ¡å™¨åŸŸå**ï¼š
   - åœ¨"å¼€å‘" -> "å¼€å‘ç®¡ç†" -> "å¼€å‘è®¾ç½®"ä¸­æ·»åŠ æœåŠ¡å™¨åŸŸå
   - requeståˆæ³•åŸŸåï¼š`https://your-domain.com`
   - uploadFileåˆæ³•åŸŸåï¼š`https://your-domain.com`
   - downloadFileåˆæ³•åŸŸåï¼š`https://your-domain.com`

3. **ä¸Šä¼ ä»£ç **ï¼š
   - ä½¿ç”¨å¾®ä¿¡å¼€å‘è€…å·¥å…·æ‰“å¼€ `miniprogram` ç›®å½•
   - ç‚¹å‡»"ä¸Šä¼ "æŒ‰é’®ä¸Šä¼ ä»£ç 
   - åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°æäº¤å®¡æ ¸

## ğŸ”’ SSL è¯ä¹¦é…ç½®ï¼ˆæ¨èï¼‰

### ä½¿ç”¨ Let's Encrypt å…è´¹è¯ä¹¦

```bash
# å®‰è£… Certbot
sudo apt install certbot python3-certbot-nginx

# è·å–è¯ä¹¦
sudo certbot --nginx -d your-domain.com

# è‡ªåŠ¨ç»­æœŸ
sudo crontab -e
# æ·»åŠ ä»¥ä¸‹è¡Œ
0 12 * * * /usr/bin/certbot renew --quiet
```

## ğŸ“Š ç›‘æ§å’Œç»´æŠ¤

### 7.1 æ—¥å¿—ç®¡ç†
```bash
# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
pm2 logs question-bank-server

# æŸ¥çœ‹ Nginx æ—¥å¿—
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log

# æ—¥å¿—è½®è½¬é…ç½®
sudo nano /etc/logrotate.d/question-bank
```

### 7.2 æ€§èƒ½ç›‘æ§
```bash
# PM2 ç›‘æ§
pm2 monit

# ç³»ç»Ÿèµ„æºç›‘æ§
htop
df -h
free -h
```

### 7.3 å¤‡ä»½ç­–ç•¥
```bash
# æ•°æ®åº“å¤‡ä»½è„šæœ¬
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
mysqldump -u question_user -p question_bank_db > /backup/question_bank_$DATE.sql
find /backup -name "question_bank_*.sql" -mtime +7 -delete
```

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æœåŠ¡æ— æ³•å¯åŠ¨**
   ```bash
   # æ£€æŸ¥ç«¯å£å ç”¨
   sudo netstat -tlnp | grep :3002
   
   # æ£€æŸ¥æ—¥å¿—
   pm2 logs question-bank-server
   ```

2. **æ•°æ®åº“è¿æ¥å¤±è´¥**
   ```bash
   # æ£€æŸ¥ MySQL çŠ¶æ€
   sudo systemctl status mysql
   
   # æµ‹è¯•è¿æ¥
   mysql -u question_user -p -h localhost question_bank_db
   ```

3. **é™æ€æ–‡ä»¶æ— æ³•è®¿é—®**
   ```bash
   # æ£€æŸ¥æ–‡ä»¶æƒé™
   sudo chown -R www-data:www-data /var/www/question-bank/admin/dist
   sudo chmod -R 755 /var/www/question-bank/admin/dist
   ```

4. **Nginx é…ç½®é”™è¯¯**
   ```bash
   # æµ‹è¯•é…ç½®
   sudo nginx -t
   
   # é‡æ–°åŠ è½½
   sudo systemctl reload nginx
   ```

## ğŸ“‹ éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] æœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡å®Œæˆ
- [ ] æ•°æ®åº“åˆ›å»ºå’Œé…ç½®å®Œæˆ
- [ ] ä»£ç éƒ¨ç½²å®Œæˆ
- [ ] ä¾èµ–å®‰è£…å®Œæˆ
- [ ] Admin å‰ç«¯æ„å»ºå®Œæˆ
- [ ] Nginx é…ç½®å®Œæˆ
- [ ] PM2 é…ç½®å®Œæˆ
- [ ] æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ
- [ ] æœåŠ¡å¯åŠ¨æˆåŠŸ
- [ ] API æ¥å£æµ‹è¯•é€šè¿‡
- [ ] é™æ€æ–‡ä»¶è®¿é—®æ­£å¸¸
- [ ] SSL è¯ä¹¦é…ç½®å®Œæˆï¼ˆå¯é€‰ï¼‰
- [ ] å°ç¨‹åºåŸŸåé…ç½®å®Œæˆ
- [ ] ç›‘æ§å’Œå¤‡ä»½ç­–ç•¥é…ç½®å®Œæˆ

## ğŸ”„ æ›´æ–°éƒ¨ç½²

### æ›´æ–°ä»£ç 
```bash
cd /var/www/question-bank
git pull origin main

# æ›´æ–°åç«¯
cd server
npm install --production
pm2 restart question-bank-server

# æ›´æ–°å‰ç«¯
cd ../admin
npm install
npm run build
sudo systemctl reload nginx
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°éƒ¨ç½²é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. æœåŠ¡å™¨æ—¥å¿—ï¼š`pm2 logs question-bank-server`
2. Nginx æ—¥å¿—ï¼š`/var/log/nginx/error.log`
3. ç³»ç»Ÿæ—¥å¿—ï¼š`journalctl -u nginx`
4. æ•°æ®åº“è¿æ¥çŠ¶æ€
5. ç½‘ç»œè¿æ¥å’Œé˜²ç«å¢™è®¾ç½®

---

**æ³¨æ„**ï¼šè¯·æ ¹æ®å®é™…ç¯å¢ƒè°ƒæ•´é…ç½®å‚æ•°ï¼Œç¡®ä¿ç”Ÿäº§ç¯å¢ƒçš„å®‰å…¨æ€§ã€‚
